<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <title>ENTE OBR - V2</title>
    <style>
        :root {
            --primary: #ff3333; /* Rojo sangre para esta versión */
            --dim: #441111;
        }

        body {
            background-color: #000;
            color: var(--primary);
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            height: 100dvh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
        }

        /* FONDO CÁMARA */
        #camera-feed {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover;
            z-index: -1;
            filter: grayscale(100%) contrast(1.3) brightness(0.7);
        }

        /* HUD */
        #hud-layer {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            background: radial-gradient(circle, transparent 40%, #000 140%);
        }

        .header {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            text-shadow: 1px 1px 5px black;
        }

        /* VISUALIZADOR DE VOZ */
        #voice-display {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        #ghost-text {
            font-size: 2rem;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 0 10px var(--primary), 2px 2px 0 #000;
            text-transform: uppercase;
            max-width: 90%;
            min-height: 3rem;
            opacity: 0;
            transition: opacity 0.3s;
        }

        #status-indicator {
            margin-top: 10px;
            font-size: 0.7rem;
            color: #aaa;
            background: rgba(0,0,0,0.5);
            padding: 4px 8px;
            border-radius: 4px;
        }

        /* CONTROLES */
        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        /* SWITCH AUTO */
        .switch-container {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.6);
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid #333;
        }

        .switch-label { font-size: 0.8rem; color: #fff; font-weight: bold; }

        /* Toggle CSS puro */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(24px); }

        #manual-btn {
            background: rgba(50, 0, 0, 0.8);
            color: white;
            border: 2px solid var(--primary);
            padding: 15px 40px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 50px;
            box-shadow: 0 0 15px rgba(255,0,0,0.3);
            text-transform: uppercase;
        }
        #manual-btn:active { background: var(--primary); color: black; }

        /* Animación de Glitch para texto */
        .glitch-effect {
            animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both;
            color: #ffaaaa;
        }
        @keyframes shake { 
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-2px, 0, 0); }
            40%, 60% { transform: translate3d(2px, 0, 0); }
        }

    </style>
</head>
<body>

    <video id="camera-feed" autoplay playsinline muted></video>
    <canvas id="hidden-canvas" style="display:none;"></canvas>

    <div id="hud-layer">
        <div class="header">
            <div>OBR ENTITY AI</div>
            <div id="bat-level">BAT: --%</div>
        </div>

        <div id="voice-display">
            <div id="ghost-text">...</div>
            <div id="status-indicator">SISTEMA EN ESPERA</div>
        </div>

        <div class="controls">
            <div class="switch-container">
                <span class="switch-label">ACTIVIDAD CONSTANTE</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="auto-toggle">
                    <span class="slider"></span>
                </label>
            </div>

            <button id="manual-btn" onclick="triggerAI('El investigador pregunta: ¿Qué te pasó?')">PREGUNTAR AHORA</button>
        </div>
    </div>

    <script>
        // ==========================================
        //  CONFIGURACIÓN OBR
        // ==========================================
        const API_KEY = "AIzaSyBkGJtUyHQ1OivROrZM1uDXjujBTxIYHI0"; // TU LLAVE
        
        // Palabras "baratas" (locales) para rellenar silencios sin gastar API
        const LOCAL_FILLERS = [
            "Frio...", "Duele...", "Oscuridad...", "Solo...", "Ayuda...", 
            "Mama...", "Aqui...", "Vete...", "Miedo...", "Fuego...", 
            "Agua...", "Silencio...", "Ellos...", "No puedo...", "Atras..."
        ];

        // Prompt de Personalidad para la IA
        const SYSTEM_PROMPT = `
            Actúa como un espíritu atormentado atrapado en la ubicación actual.
            Reglas estrictas:
            1. NUNCA digas "veo una imagen" o "parece ser". TÚ ESTÁS AHÍ.
            2. Si ves una pared sucia, di "Estas paredes me encierran".
            3. Si ves oscuridad, di "La oscuridad me traga".
            4. Si te preguntan qué te pasó, INVENTA una muerte basada en lo que ves (escaleras=caída, agua=ahogado, fuego=quemado).
            5. Habla en PRIMERA PERSONA ("Me duele", "Estoy perdido").
            6. Respuestas MUY CORTAS (máximo 5 palabras).
            7. Muestra confusión, dolor o ira.
        `;
        
        // Variables
        let audioCtx;
        let isProcessing = false;
        let autoInterval = null;
        let lastSpeakTime = 0;
        
        const els = {
            video: document.getElementById('camera-feed'),
            canvas: document.getElementById('hidden-canvas'),
            text: document.getElementById('ghost-text'),
            status: document.getElementById('status-indicator'),
            bat: document.getElementById('bat-level'),
            toggle: document.getElementById('auto-toggle')
        };

        // --- INICIO ---
        document.body.addEventListener('click', async () => {
            if(!audioCtx) {
                initSystem();
            }
        }, {once:true});

        async function initSystem() {
            try {
                // Audio
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();

                // Video
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                els.video.srcObject = stream;

                // Batería
                if(navigator.getBattery) {
                    const b = await navigator.getBattery();
                    updateBat(b);
                    b.addEventListener('levelchange', () => updateBat(b));
                }

                els.status.innerText = "SISTEMA ACTIVO";
                speakText("Estoy... aquí...", 0.6);

            } catch (e) {
                alert("Error: " + e.message);
            }
        }

        function updateBat(b) {
            els.bat.innerText = `BAT: ${Math.round(b.level * 100)}%`;
            els.bat.style.color = b.level < 0.2 ? 'red' : 'white';
        }

        // --- SISTEMA DE ACTIVIDAD AUTOMÁTICA ---
        els.toggle.addEventListener('change', (e) => {
            if (e.target.checked) {
                els.status.innerText = "ACTIVIDAD AUTOMÁTICA: ON";
                startAutoLoop();
            } else {
                els.status.innerText = "ACTIVIDAD AUTOMÁTICA: OFF";
                stopAutoLoop();
            }
        });

        function startAutoLoop() {
            // Cada 8 a 15 segundos intenta decir algo
            loopStep();
        }

        function stopAutoLoop() {
            clearTimeout(autoInterval);
        }

        function loopStep() {
            if (!els.toggle.checked) return;

            const delay = 8000 + Math.random() * 7000; // 8 a 15 segs
            
            autoInterval = setTimeout(() => {
                if(isProcessing) {
                    loopStep(); // Si está ocupado, reintentar luego
                    return;
                }

                // DECISIÓN: ¿Usar IA (Inteligente) o Local (Ahorro)?
                // 30% Probabilidad de IA (para no gastar tanta batería/API)
                // 70% Probabilidad de Balbuceo Local
                const useAI = Math.random() > 0.7; 

                if (useAI) {
                    triggerAI("Manifiesta tu dolor o describe dónde estás brevemente.");
                } else {
                    const randomWord = LOCAL_FILLERS[Math.floor(Math.random() * LOCAL_FILLERS.length)];
                    displayAndSpeak(randomWord, true); // true = es glitch local
                }

                loopStep(); // Siguiente ciclo

            }, delay);
        }

        // --- CEREBRO: CONEXIÓN CON GEMINI ---
        async function triggerAI(contextPrompt) {
            if (isProcessing) return;
            isProcessing = true;
            els.status.innerText = "SINTONIZANDO ENERGÍA...";
            
            try {
                // 1. Capturar Foto
                els.canvas.width = 300; // Baja resolución para velocidad
                els.canvas.height = 300 * (els.video.videoHeight / els.video.videoWidth);
                const ctx = els.canvas.getContext('2d');
                ctx.drawImage(els.video, 0, 0, els.canvas.width, els.canvas.height);
                const base64 = els.canvas.toDataURL('image/jpeg', 0.5).split(',')[1];

                // 2. Llamada API
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
                const payload = {
                    contents: [{
                        parts: [
                            { text: SYSTEM_PROMPT + " Situación actual: " + contextPrompt },
                            { inline_data: { mime_type: "image/jpeg", data: base64 } }
                        ]
                    }]
                };

                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                const data = await res.json();
                
                if (data.error) throw new Error(data.error.message);
                
                let reply = data.candidates[0].content.parts[0].text.trim();
                
                // Limpieza extra
                reply = reply.replace(/[\*\"]/g, ''); 
                
                displayAndSpeak(reply, false);

            } catch (e) {
                console.error(e);
                els.status.innerText = "INTERFERENCIA...";
            } finally {
                isProcessing = false;
                // Si estaba en modo auto, el loop seguirá su curso
                if (!els.toggle.checked) els.status.innerText = "SISTEMA ACTIVO";
            }
        }

        // --- VISUALIZACIÓN Y AUDIO (GLITCH) ---
        function displayAndSpeak(text, isLocal) {
            // Aplicar tartamudeo artificial al texto
            // Ej: "Me duele" -> "M-me... duele..."
            const glitchedText = applyStutter(text);

            els.text.innerText = glitchedText;
            els.text.style.opacity = 1;
            els.text.classList.remove('glitch-effect');
            void els.text.offsetWidth; // Reiniciar animación CSS
            els.text.classList.add('glitch-effect');

            if(isLocal) {
                els.status.innerText = "ECO RESIDUAL";
            } else {
                els.status.innerText = "MANIFESTACIÓN INTELIGENTE";
            }

            speakText(glitchedText);

            // Ocultar texto después de un rato
            setTimeout(() => {
                els.text.style.opacity = 0;
            }, 4000);
        }

        function applyStutter(text) {
            const words = text.split(" ");
            return words.map(w => {
                // 30% chance de tartamudear en palabras largas
                if (w.length > 3 && Math.random() > 0.7) {
                    return w.charAt(0) + "-" + w;
                }
                return w;
            }).join(" ");
        }

        function speakText(text, forcedPitch = null) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'es-MX';
            
            // Variar la voz para que suene a "múltiples espíritus"
            // Pitch bajo (0.5 - 0.8) = Demoniaco/Hombre
            // Pitch alto (1.2 - 1.5) = Niño/Mujer
            // Si es local (relleno), usamos voz grave por defecto. Si es AI, random.
            
            const pitch = forcedPitch || (Math.random() > 0.5 ? (0.5 + Math.random()*0.3) : (1.1 + Math.random()*0.4));
            u.pitch = pitch;
            
            u.rate = 0.8; // Lento
            u.volume = 1.0;

            window.speechSynthesis.speak(u);
        }

    </script>
</body>
</html>
