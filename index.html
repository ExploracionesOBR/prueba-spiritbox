<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VOX - EXPLORACIONES OBR</title>
    <style>
        :root {
            --primary-color: #ff0000;
            --bg-color: #050505;
            --text-color: #e0e0e0;
            --panel-bg: rgba(20, 20, 20, 0.95);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh; /* Altura completa viewport */
            height: 100dvh; /* Altura dinámica para móviles modernos */
            overflow: hidden;
            user-select: none;
            touch-action: manipulation; /* Mejor respuesta tactil */
            transition: background-color 0.1s ease-out;
        }

        /* Header ajustado para móvil */
        header {
            flex: 0 0 auto;
            padding: 10px 0;
            text-align: center;
            background: linear-gradient(180deg, rgba(50,0,0,0.9) 0%, rgba(0,0,0,0) 100%);
            z-index: 10;
        }

        h1 {
            margin: 0;
            font-size: 1.1rem;
            letter-spacing: 1px;
            color: var(--primary-color);
            text-shadow: 0 0 10px var(--primary-color);
        }

        .subtitle { font-size: 0.6rem; color: #888; }

        /* Panel de Diagnóstico de Sensores */
        #sensor-debug {
            font-size: 0.55rem;
            color: #555;
            text-align: center;
            padding: 5px;
            border-bottom: 1px solid #222;
            white-space: pre-wrap;
            line-height: 1.2;
        }
        .status-ok { color: #00ff00; }
        .status-err { color: #ff0000; }

        /* Área Visual Principal */
        #visualizer-container {
            flex: 1 1 auto; /* Ocupa el espacio restante */
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        canvas {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 0 5px var(--primary-color));
        }

        /* Palabra Fantasma */
        #current-word {
            position: absolute;
            font-size: 2rem;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 20px var(--primary-color);
            text-transform: uppercase;
            text-align: center;
            width: 90%;
            opacity: 0;
            transition: opacity 0.5s ease-out;
            pointer-events: none;
            z-index: 20;
        }

        /* Historial Flotante */
        #log-container {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 40%;
            max-height: 150px;
            overflow-y: hidden;
            font-size: 0.6rem;
            text-align: right;
            pointer-events: none;
            z-index: 5;
            display: flex;
            flex-direction: column-reverse; /* Lo más nuevo abajo visualmente si se invierte lógica */
        }
        
        .log-entry { margin-bottom: 3px; color: rgba(255, 255, 255, 0.7); text-shadow: 1px 1px 0 #000; }

        /* Panel de Control - Optimizado para pulgares */
        #controls {
            flex: 0 0 auto;
            padding: 20px 15px 30px 15px; /* Más padding abajo para iPhone home bar */
            background: var(--panel-bg);
            border-top: 2px solid #333;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 50;
        }

        .slider-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            font-weight: bold;
        }

        input[type=range] {
            width: 65%;
            height: 25px; /* Área táctil más grande */
            accent-color: var(--primary-color);
        }

        .btn-main {
            background: rgba(0,0,0,0.5);
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 18px;
            font-size: 1.1rem;
            font-weight: 900;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.1);
            touch-action: manipulation;
        }

        .btn-main:active {
            background: var(--primary-color);
            color: #000;
        }

        /* Pantalla de "Gira tu teléfono" si se usa en horizontal */
        @media screen and (orientation: landscape) and (max-height: 500px) {
            #visualizer-container::after {
                content: "MODO VERTICAL REQUERIDO";
                position: absolute;
                top: 0; left: 0; right: 0; bottom: 0;
                background: black;
                color: red;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                z-index: 100;
            }
        }
    </style>
</head>
<body>

    <header>
        <h1>EXPLORACIONES OBR</h1>
        <div class="subtitle">SENSOR SYSTEM PRO / iOS COMPATIBLE</div>
    </header>

    <div id="sensor-debug">ESPERANDO INICIO...</div>

    <div id="visualizer-container">
        <canvas id="scope"></canvas>
        <div id="current-word"></div>
        <div id="log-container"></div>
    </div>

    <div id="controls">
        <div class="slider-group">
            <span>SENSIBILIDAD</span>
            <input type="range" id="sensitivity" min="1" max="100" value="60">
        </div>
        <div class="slider-group">
            <span>REVERB</span>
            <input type="range" id="reverb" min="0" max="100" value="30">
        </div>
        <button class="btn-main" id="power-btn">INICIAR SENSORES</button>
    </div>

    <script>
        // --- DICCIONARIO OBR ---
        const dictionary = [
            "AYUDA", "AQUI", "FUERA", "MIEDO", "SOLO", "FRIO", "MUERTE", "CORRE", 
            "ATRAS", "MIRA", "BAJO", "LUZ", "SOMBRA", "DOLOR", "NIÑO", "NIÑA", 
            "MAMA", "PAPA", "FUEGO", "AGUA", "TIERRA", "AIRE", "ESCUCHA", "VEN", 
            "VETE", "NOMBRE", "TUMBA", "CRUZ", "DIABLO", "DIOS", "SANTOS", "ROJO", 
            "NEGRO", "SANGRE", "LLANTO", "GRITO", "PUERTA", "LLAVE", "CERRADO", 
            "ABIERTO", "HOLA", "ADIOS", "NOCHE", "DIA", "AYER", "HOY", "SIEMPRE", 
            "NUNCA", "ASESINO", "VIGILA", "ESCONDIDO", "OBREGON", "SONORA", "VALLE",
            "CANAL", "RODEO", "HOTEL", "ESCUELA", "HOSPITAL", "CEMENTERIO", "ENTERRADO"
        ];

        // Variables de Sistema
        let isRunning = false;
        let audioContext, analyser, gainNode;
        let canvas, ctx;
        let lastSpeakTime = 0;
        
        // Variables de Sensores Reales
        let sensorData = {
            alpha: 0, // Brújula / Magnetómetro
            beta: 0,  // Inclinación X
            gamma: 0, // Inclinación Y
            accX: 0,
            accY: 0,
            accZ: 0
        };
        
        let lastSensorData = { alpha: 0, beta: 0, gamma: 0 };
        let sensorDeltaSum = 0; // Acumulador de cambios bruscos

        // DOM Elements
        const powerBtn = document.getElementById('power-btn');
        const sensitivityInput = document.getElementById('sensitivity');
        const wordDisplay = document.getElementById('current-word');
        const logContainer = document.getElementById('log-container');
        const debugPanel = document.getElementById('sensor-debug');
        const bodyElement = document.body;

        // --- MANEJO DE PERMISOS IOS ---
        async function requestPermissions() {
            // iOS 13+ requiere permiso explícito para DeviceOrientation
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const permissionState = await DeviceOrientationEvent.requestPermission();
                    if (permissionState === 'granted') {
                        return true;
                    } else {
                        debugPanel.innerHTML = "<span class='status-err'>PERMISO DENEGADO POR USUARIO</span>";
                        return false;
                    }
                } catch (e) {
                    console.error(e);
                    return false;
                }
            }
            return true; // No es iOS o versión vieja
        }

        // --- INICIALIZACIÓN DE SENSORES ---
        function startSensors() {
            window.addEventListener('deviceorientation', handleOrientation);
            window.addEventListener('devicemotion', handleMotion);
            
            // Verificar si estamos recibiendo datos después de 500ms
            setTimeout(() => {
                let statusMsg = "SENSORES: ";
                const orientOK = sensorData.alpha !== 0 || sensorData.beta !== 0;
                const motionOK = sensorData.accX !== 0 || sensorData.accY !== 0;

                if(orientOK) statusMsg += "<span class='status-ok'>BRÚJULA [OK]</span> ";
                else statusMsg += "<span class='status-err'>BRÚJULA [NO]</span> ";

                if(motionOK) statusMsg += "<span class='status-ok'>MOVIMIENTO [OK]</span>";
                else statusMsg += "<span class='status-err'>MOVIMIENTO [NO]</span>";

                if(!orientOK && !motionOK) statusMsg += "<br>(Mueve el celular para activar)";

                debugPanel.innerHTML = statusMsg;
            }, 1000);
        }

        function stopSensors() {
            window.removeEventListener('deviceorientation', handleOrientation);
            window.removeEventListener('devicemotion', handleMotion);
            debugPanel.innerHTML = "SISTEMA EN ESPERA";
        }

        function handleOrientation(event) {
            // Alpha es la brújula (0-360), Beta/Gamma inclinación
            sensorData.alpha = event.alpha || 0;
            sensorData.beta = event.beta || 0;
            sensorData.gamma = event.gamma || 0;
        }

        function handleMotion(event) {
            // Aceleración incluyendo gravedad
            sensorData.accX = event.accelerationIncludingGravity.x || 0;
            sensorData.accY = event.accelerationIncludingGravity.y || 0;
            sensorData.accZ = event.accelerationIncludingGravity.z || 0;
        }

        // --- MOTOR DE AUDIO ---
        function initAudio() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioContext = new AudioContext();
            
            // Ruido Rosa/Blanco
            const bufferSize = 2 * audioContext.sampleRate;
            const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                // Math.random base + inyección leve de datos de sensor para "semilla"
                output[i] = (Math.random() * 2 - 1);
            }

            const whiteNoise = audioContext.createBufferSource();
            whiteNoise.buffer = noiseBuffer;
            whiteNoise.loop = true;
            
            const filter = audioContext.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 1000;

            gainNode = audioContext.createGain();
            gainNode.gain.value = 0.05;

            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;

            whiteNoise.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(analyser);
            analyser.connect(audioContext.destination);
            
            whiteNoise.start(0);
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                // Cancelar cualquier cosa que se esté diciendo
                window.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-MX';
                utterance.pitch = 0.7; // Voz más profunda
                utterance.rate = 0.8;
                utterance.volume = 1;

                wordDisplay.innerText = text;
                wordDisplay.style.opacity = 1;
                
                const p = document.createElement('div');
                p.className = 'log-entry';
                const time = new Date().toLocaleTimeString().split(' ')[0];
                p.innerText = `[${time}] ${text}`;
                logContainer.prepend(p);

                window.speechSynthesis.speak(utterance);
                
                setTimeout(() => { wordDisplay.style.opacity = 0; }, 2500);
            }
        }

        function triggerFlash() {
            bodyElement.style.backgroundColor = 'var(--primary-color)';
            setTimeout(() => {
                 bodyElement.style.backgroundColor = 'var(--bg-color)';
            }, 100);
        }

        // --- BUCLE PRINCIPAL (LOOP) ---
        function loop() {
            if (!isRunning) return;
            requestAnimationFrame(loop);

            // 1. Calcular "Delta" (Cambio en sensores)
            // Calculamos cuánto cambiaron los valores desde el último frame
            let delta = 
                Math.abs(sensorData.alpha - lastSensorData.alpha) +
                Math.abs(sensorData.beta - lastSensorData.beta) +
                Math.abs(sensorData.gamma - lastSensorData.gamma);

            // Filtro de ruido simple para evitar disparos por temblor de mano
            if (delta < 0.5) delta = 0; // Ignorar micro movimientos
            
            // Factor aleatorio base (siempre hay un poco de azar, como en la app real)
            let randomNoise = Math.random() * 2; 
            
            // Valor total de "Anomalía"
            let anomalyScore = delta + randomNoise;

            // Guardar estado para siguiente frame
            lastSensorData = { ...sensorData };

            // 2. Umbral de disparo
            // Slider 1 (Poco Sensible) a 100 (Muy Sensible)
            // Invertimos lógica: Slider Alto = Umbral Bajo
            const sensValue = parseInt(sensitivityInput.value);
            const triggerThreshold = 105 - sensValue; // Si sens=100, umbral=5. Si sens=1, umbral=104

            const now = Date.now();

            // Lógica de disparo
            if (anomalyScore > triggerThreshold && (now - lastSpeakTime > 3000)) {
                // Disparo confirmado
                triggerFlash();
                const word = dictionary[Math.floor(Math.random() * dictionary.length)];
                
                // Glitch de audio
                gainNode.gain.cancelScheduledValues(audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.05, audioContext.currentTime + 0.5);
                
                speak(word);
                lastSpeakTime = now;
            }

            // 3. Dibujar Visualizador
            drawScope();
        }

        function drawScope() {
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteTimeDomainData(dataArray);

            ctx.fillStyle = 'rgba(5, 5, 5, 1)'; 
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.lineWidth = 2;
            ctx.strokeStyle = '#ff0000';
            ctx.beginPath();

            const sliceWidth = canvas.width * 1.0 / bufferLength;
            let x = 0;

            for(let i = 0; i < bufferLength; i++) {
                const v = dataArray[i] / 128.0;
                
                // Modificar la onda visualmente si hay actividad en sensores
                let jitter = 0;
                if(sensorData.accX > 1 || sensorData.accY > 1) {
                    jitter = (Math.random() - 0.5) * 10;
                }

                const y = (v * canvas.height / 2) + jitter;

                if(i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);

                x += sliceWidth;
            }
            ctx.lineTo(canvas.width, canvas.height/2);
            ctx.stroke();
        }

        // --- CONTROLADORES DE EVENTOS ---
        powerBtn.addEventListener('click', async () => {
            if (!isRunning) {
                // 1. Pedir permisos primero (Crucial para iOS)
                const granted = await requestPermissions();
                
                if(granted) {
                    if (!audioContext) initAudio();
                    if (audioContext.state === 'suspended') audioContext.resume();
                    
                    startSensors();
                    isRunning = true;
                    
                    powerBtn.innerText = "DETENER";
                    powerBtn.style.borderColor = "#fff";
                    powerBtn.style.color = "#fff";
                    
                    // Setup Canvas
                    canvas = document.getElementById('scope');
                    ctx = canvas.getContext('2d');
                    resizeCanvas();
                    
                    loop();
                }
            } else {
                isRunning = false;
                stopSensors();
                powerBtn.innerText = "INICIAR SENSORES";
                powerBtn.style.borderColor = "var(--primary-color)";
                powerBtn.style.color = "var(--primary-color)";
                window.speechSynthesis.cancel();
            }
        });

        function resizeCanvas() {
            const container = document.getElementById('visualizer-container');
            if(canvas && container) {
                canvas.width = container.offsetWidth;
                canvas.height = container.offsetHeight;
            }
        }
        window.addEventListener('resize', resizeCanvas);

    </script>
</body>
</html>